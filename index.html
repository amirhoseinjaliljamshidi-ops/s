<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯Ø±Ø³Ù‡ â€” Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
<link href="https://cdn.fontcdn.ir/Font/Persian/IRANSansX/IRANSansX.css" rel="stylesheet">
<style>
:root{--primary:#0b63b6;--dark:#003c7a;--bg:#f3f6fb;--card:#ffffff}
*{box-sizing:border-box}
body{margin:0;font-family:"IRANSansX","Vazir",Tahoma,Arial,sans-serif;background:var(--bg);color:#111;direction:rtl}
.header{background:var(--primary);color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;position:relative}
.title{font-size:18px;font-weight:700}
.container{padding:16px;max-width:1100px;margin:0 auto}
.menuBtn{background:#fff;border-radius:8px;padding:8px;border:none;cursor:pointer;font-weight:700}
.menuPanel{position:absolute; left:16px; top:56px;background:#fff;color:#000;border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.12);width:320px; z-index:1000; display:none; overflow:auto; max-height:60vh}
.menuPanel div{padding:12px 14px;border-bottom:1px solid #eee;cursor:pointer;color:#000;font-weight:600}
.menuPanel div:hover{background:#f6f8fb}
.loginBox{max-width:520px;margin:6vh auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.08);text-align:center}
.input{width:100%;padding:10px;margin-top:10px;border-radius:8px;border:1px solid #ccc}
.button{background:var(--primary);color:#fff;padding:9px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:inline-block;margin:8px;width:170px;text-align:center;cursor:pointer}
.lessonHeader{background:var(--dark);color:#fff;padding:12px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.fileList{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.04)}
.small{font-size:13px;color:#555}
.section{display:none}
.assignmentItem{background:#fff;padding:10px;border-radius:8px;border:1px solid #eef3fb;margin-bottom:8px}
select,input[type=file],textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
a.downloadLink{display:inline-block;padding:8px 10px;border-radius:8px;background:#e9f2ff;color:#003c7a;text-decoration:none;font-weight:700}
.notice{background:#fff7e6;padding:10px;border-radius:8px;border:1px solid #ffe4b5;margin-bottom:12px}
.alerts{background:#fff;padding:10px;border-radius:8px;max-height:320px;overflow:auto}
.alert-item{padding:8px;border-bottom:1px solid #eee;font-size:13px}
.badge{background:#ff4d4f;color:#fff;padding:2px 6px;border-radius:10px;font-size:12px;display:inline-block}
.hidden{display:none}
.whiteBox{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.06);max-height:360px;overflow:auto}
.top-right {position:fixed; top:12px; right:12px; z-index:1200}
</style>
</head>
<body>

<div class="header">
  <div class="title">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯Ø±Ø³Ù‡ â€” Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</div>
  <div style="display:flex;gap:10px;align-items:center">
    <button id="menuToggle" class="menuBtn">â˜° Ù…Ù†Ùˆ</button>
    <div id="menuPanel" class="menuPanel" role="menu"></div>
    <div style="position:relative">
      <button id="bellBtn" class="menuBtn">ğŸ””</button>
      <span id="bellDot" class="badge" style="position:absolute; top:-6px; left:-6px; display:none">!</span>
    </div>
  </div>
</div>

<div class="container">

  <!-- LOGIN -->
  <div id="loginSection" class="section" style="display:block">
    <div class="loginBox">
      <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡ Ù…Ø¯Ø±Ø³Ù‡</h2>
      <input id="loginName" class="input" placeholder="Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ÛŒØ§ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù…ÛŒØ± Ø§Ø­Ù…Ø¯ÛŒ ÛŒØ§ modir_kol)"/>
      <input id="loginPass" class="input" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Ø±Ù…Ø² Ø§ÙˆÙ„ÛŒÙ‡ = Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ)"/>
      <div style="display:flex;gap:10px;margin-top:12px;justify-content:center">
        <button class="button" onclick="doLogin()">ÙˆØ±ÙˆØ¯</button>
      </div>
      <div class="small" style="margin-top:10px;color:#666">Ù‡Ø± Ø¨Ø§Ø± ØµÙØ­Ù‡ Ø±ÛŒÙ„ÙˆØ¯ Ø´ÙˆØ¯ ÛŒØ§ ØªØ¨ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯ â€” Ù†ÛŒØ§Ø² Ø¨Ù‡ ÙˆØ±ÙˆØ¯ Ù…Ø¬Ø¯Ø¯ Ø§Ø³Øª.</div>
      <div id="loginError" class="small" style="color:red;margin-top:8px"></div>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="container section">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div id="greeting" style="font-weight:700">Ø³Ù„Ø§Ù… --- Ø¹Ø²ÛŒØ² ğŸ‘‹</div>
        <div id="roleLabel" class="small"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="logoutBtn" class="menuBtn" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div style="margin-top:14px">
      <h3>Ø¯Ø±Ø³â€ŒÙ‡Ø§ â€” Ù¾Ø§ÛŒÙ‡ Ù‡ÙØªÙ…</h3>
      <div id="lessonsWrap"></div>
    </div>
  </div>

  <!-- LESSON PAGE -->
  <div id="lessonPage" class="container section">
    <div class="lessonHeader">
      <div>
        <div id="lessonTitle" style="font-size:18px;font-weight:700">Ø¯Ø±Ø³</div>
        <div id="lessonTeacher" class="small"></div>
      </div>
      <div class="lessonButtons" id="lessonButtons"></div>
    </div>

    <div id="lessonMain">
      <div id="lessonInfo" class="fileList small">Ù‡ÛŒÚ† Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</div>
      <div style="margin-top:12px"><button class="button" onclick="goToDashboard()">Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button></div>
    </div>
  </div>

  <!-- BOOKS -->
  <div id="booksPage" class="container section">
    <div class="lessonHeader">
      <div><strong>Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø¯Ø±Ø³ÛŒ</strong></div>
      <div><button class="button" onclick="goToDashboard()">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div>
    </div>
    <div id="booksList" class="fileList"></div>
  </div>

  <!-- ASSIGNMENTS -->
  <div id="assignmentsPage" class="container section">
    <div class="lessonHeader"><div><strong id="assignTitle">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ø§Ù„ÛŒÙ</strong></div><div><button class="button" onclick="goToDashboard()">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div></div>
    <div id="assignControls" style="background:#fff;padding:12px;border-radius:8px"></div>
    <div id="assignList" style="margin-top:12px"></div>
  </div>

  <!-- SUBMIT -->
  <div id="submitPage" class="container section">
    <div class="lessonHeader"><div><strong>Ø§Ø±Ø³Ø§Ù„ ØªÚ©Ù„ÛŒÙ</strong></div><div><button class="button" onclick="goToDashboard()">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div></div>
    <div style="background:#fff;padding:12px;border-radius:8px">
      <label class="small">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³</label>
      <select id="sendLessonSelect"></select>
      <label class="small" style="margin-top:8px">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¹Ù„Ù…</label>
      <select id="sendTeacherSelect"></select>
      <label class="small" style="margin-top:8px">ÙØ§ÛŒÙ„ (PDF ÛŒØ§ ØªØµÙˆÛŒØ±)</label>
      <input type="file" id="sendFile" accept="application/pdf,image/*"/>
      <div style="margin-top:10px">
        <button class="button" onclick="studentSendAssignment()">Ø§Ø±Ø³Ø§Ù„</button>
        <span id="sendMsg" class="small" style="margin-left:10px;color:green"></span>
      </div>
    </div>
  </div>

  <!-- TEACHER BROADCAST -->
  <div id="teacherBroadcastPage" class="container section">
    <div class="lessonHeader"><div><strong>Ø§Ø±Ø³Ø§Ù„ ØªÚ©Ù„ÛŒÙ Ø¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù† (Ù…Ø¹Ù„Ù…)</strong></div><div><button class="button" onclick="goToDashboard()">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div></div>
    <div style="background:#fff;padding:12px;border-radius:8px">
      <label class="small">Ø¯Ø±Ø³</label>
      <select id="teacherBroadcastLesson"></select>
      <label class="small" style="margin-top:8px">Ù…ØªÙ† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <textarea id="teacherBroadcastText" rows="3" placeholder="Ù…ØªÙ† ØªÚ©Ù„ÛŒÙ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>
      <label class="small" style="margin-top:8px">ÙØ§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
      <input type="file" id="teacherBroadcastFile" accept="application/pdf,image/*"/>
      <div style="margin-top:10px">
        <button class="button" onclick="teacherBroadcast()">Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù‡Ù…Ù‡</button>
        <span id="teacherBroadcastMsg" class="small" style="margin-left:10px;color:green"></span>
      </div>
    </div>
  </div>

  <!-- FEEDBACK (student) -->
  <div id="feedbackPage" class="container section">
    <div class="lessonHeader"><div><strong>Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù…Ø¹Ù„Ù…</strong></div><div><button class="button" onclick="goToDashboard()">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div></div>
    <div style="background:#fff;padding:12px;border-radius:8px">
      <label class="small">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø¹Ù„Ù…</label>
      <select id="feedbackTeacherSelect"></select>
      <div id="feedbackResults" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- TEACHER VIEW ASSIGNMENTS -->
  <div id="teacherViewAssignments" class="container section">
    <div style="background:#fff;padding:12px;border-radius:8px">
      <h3>Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ø§Ù„ÛŒÙ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†</h3>
      <label class="small">Ø¯Ø±Ø³</label>
      <select id="tvLesson" class="input"></select>
      <label class="small" style="margin-top:8px">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²</label>
      <select id="tvStudent" class="input"></select>
      <div style="margin-top:8px;display:flex;gap:8px">
        <button class="button" onclick="teacherView()">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ù„ÛŒÙ</button>
        <button class="button" onclick="closeSection('teacherViewAssignments')">Ø¨Ø§Ø²Ú¯Ø´Øª</button>
      </div>
      <div id="tvList" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div id="profilePage" class="container section">
    <div class="lessonHeader"><div><strong>Ù¾Ø±ÙˆÙØ§ÛŒÙ„</strong></div><div><button class="button" onclick="goToDashboard()">Ø¨Ø§Ø²Ú¯Ø´Øª</button></div></div>
    <div style="background:#fff;padding:12px;border-radius:8px">
      <div id="profileInfo" class="small"></div>
      <label class="small" style="margin-top:8px">ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±:</label>
      <input type="password" id="newPassword" class="input" placeholder="Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯"/>
      <input type="password" id="newPassword2" class="input" placeholder="ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯"/>
      <div style="margin-top:8px"><button class="button" onclick="changePassword()">Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø²</button></div>
      <div id="profileMsg" class="small" style="color:green;margin-top:8px"></div>
    </div>
  </div>

  <!-- NOTIFICATIONS white box (hidden by default, toggled by bell) -->
  <div id="notificationsBox" class="whiteBox hidden" style="position:fixed; top:70px; left:20px; z-index:1300; width:360px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <strong>Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</strong>
      <div>
        <button class="button" onclick="markAllRead()">Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù‡Ù…Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø®ÙˆØ§Ù†Ø¯Ù‡â€ŒØ´Ø¯Ù‡</button>
        <button class="button" onclick="closeNotifications()">Ø¨Ø³ØªÙ†</button>
      </div>
    </div>
    <div id="notificationsList"></div>
  </div>

  <div class="footer-note" style="margin-top:20px">Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§: Ø³Ø±ÙˆØ± Ø±Ø§ Ø¨Ø§ node server.js Ø§Ø¬Ø±Ø§ Ú©Ù† â€” Ø³Ù¾Ø³ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø±Ø§ Ø§Ø² http://localhost:3000/index.html Ø¨Ø§Ø² Ú©Ù†.</div>

</div>

<script>
/* ========== Config ========== */
const API = '/api';
const POLL_INTERVAL = 1500;

const SUBJECTS = ["Ø¹Ù„ÙˆÙ…","Ø±ÛŒØ§Ø¶ÛŒ","ÙØ§Ø±Ø³ÛŒ","Ù†Ú¯Ø§Ø±Ø´","ØªÙÚ©Ø± Ùˆ Ø³Ø¨Ú© Ø²Ù†Ø¯Ú¯ÛŒ","Ú©Ø§Ø± Ùˆ ÙÙ†Ø§ÙˆØ±ÛŒ","Ù‚Ø±Ø¢Ù†","Ø¯ÛŒÙ†ÛŒ","Ø¹Ø±Ø¨ÛŒ","English student book","English workbook","Ù…Ø·Ø§Ù„Ø¹Ø§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ","Ù‡Ù†Ø±"];
const STUDENTS = ["Ø§Ù…ÛŒØ± Ø§Ø­Ù…Ø¯ÛŒ","Ù…Ø­Ù…Ø¯ Ø±Ø¶Ø§ÛŒÛŒ","Ø¹Ù„ÛŒ Ú©Ø±ÛŒÙ…ÛŒ","Ø±Ø¶Ø§ Ù…ÙˆØ³ÙˆÛŒ","Ø­Ø³ÛŒÙ† Ù‚Ø§Ø³Ù…ÛŒ","Ø³ÛŒÙ†Ø§ Ú©Ø§Ø¸Ù…ÛŒ","Ù…Ù‡Ø±Ø¯Ø§Ø¯ ØµØ§Ø¯Ù‚ÛŒ","Ø§Ù…ÛŒØ¯ Ø³Ù„ÛŒÙ…Ø§Ù†ÛŒ","Ù†ÙˆÛŒØ¯ Ø§Ø­Ù…Ø¯ÛŒ","Ø¢Ø±Ø´ Ø­Ø³ÛŒÙ†ÛŒ","Ø´Ø§ÛŒØ§Ù† ÛŒÙˆØ³ÙÛŒ","Ù¾Ø§Ø±Ø³Ø§ Ù†ÙˆØ±ÛŒ","Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ù…Ø­Ù…Ø¯ÛŒ","Ú©ÛŒØ§Ù† ØªÙˆØ³Ù„ÛŒ","Ù…Ù‡Ø¯ÛŒ Ø·Ø§Ù‡Ø±ÛŒ","Ø¹Ù„ÛŒ Ø±Ø¶Ø§ Ø²Ø§Ø¯Ù‡","Ø³Ø¬Ø§Ø¯ Ú©Ø±ÛŒÙ…ÛŒ","Ø¢Ø±Ù…Ø§Ù† ØµØ§Ø¯Ù‚ÛŒ","Ø§Ø­Ù…Ø¯ ØªÙˆØ³Ù„ÛŒ","Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ø¬Ù„ÛŒÙ„ Ø¬Ù…Ø´ÛŒØ¯ÛŒ"];
const TEACHERS = ["Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…ÙˆØ¯ÛŒ","Ø¢Ù‚Ø§ÛŒ Ø­Ø³ÛŒÙ†ÛŒ","Ø¢Ù‚Ø§ÛŒ Ú©Ø±ÛŒÙ…ÛŒ","Ø¢Ù‚Ø§ÛŒ Ù…ÙˆØ³ÙˆÛŒ","Ø¢Ù‚Ø§ÛŒ Ù‚Ø§Ø³Ù…ÛŒ","Ø¢Ù‚Ø§ÛŒ Ú©Ø§Ø¸Ù…ÛŒ","Ø¢Ù‚Ø§ÛŒ ØµØ§Ø¯Ù‚ÛŒ","Ø¢Ù‚Ø§ÛŒ Ø³Ù„ÛŒÙ…Ø§Ù†ÛŒ","Ø¢Ù‚Ø§ÛŒ Ø§Ø­Ù…Ø¯ÛŒ","Ø¢Ù‚Ø§ÛŒ Ø­Ø³ÛŒÙ†ÛŒ_2","Ø¢Ù‚Ø§ÛŒ ÛŒÙˆØ³ÙÛŒ","Ø¢Ù‚Ø§ÛŒ Ù†ÙˆØ±ÛŒ","Ø¢Ù‚Ø§ÛŒ Ù…Ø­Ù…Ø¯ÛŒ","Ø¢Ù‚Ø§ÛŒ Ø·Ø§Ù‡Ø±ÛŒ"];

// managers as requested (their names in DB: modir_kol, modir_madrese, nazem1, nazem_motaleat)
const MANAGERS = ["modir_kol","modir_madrese","nazem1","nazem_motaleat"];

let currentUser = null;
let currentRole = null;
let currentLesson = null;
let state = { sessions:{}, assignments:[], feedbacks:[], notifications:[], books:{} };

/* ========== Helpers ========== */
function api(path, method='GET', body=null){
  const opts = { method, headers:{} };
  if(body && !(body instanceof FormData)){ opts.headers['Content-Type']='application/json'; opts.body = JSON.stringify(body); }
  else if(body instanceof FormData) opts.body = body;
  return fetch(API + path, opts).then(r=>r.json());
}
function hideAllSections(){ document.querySelectorAll('.section').forEach(s=>s.style.display='none'); }
function openSection(id){ hideAllSections(); document.getElementById(id).style.display='block'; }
function setText(id, txt){ if(document.getElementById(id)) document.getElementById(id).innerText = txt; }

/* ========== Login ========== */
async function doLogin(){
  const name = document.getElementById('loginName').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if(!name || !pass){ setText('loginError','Ù†Ø§Ù… Ùˆ Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  const res = await api('/login','POST',{ name, pass });
  if(res.error){ setText('loginError', res.error); return; }
  currentUser = name;
  currentRole = res.role; // 'student' | 'teacher' | 'manager'
  setText('loginError','');
  await afterLogin();
}

/* ========== After login ========== */
async function afterLogin(){
  hideAllSections();
  openSection('dashboard');
  setText('greeting', `Ø³Ù„Ø§Ù… ${currentUser} Ø¹Ø²ÛŒØ² ğŸ‘‹`);
  setText('roleLabel', `Ù†Ù‚Ø´: ${currentRole==='manager'?'Ù…Ø¯ÛŒØ±/Ù†Ø§Ø¸Ù…': (currentRole==='teacher'?'Ù…Ø¹Ù„Ù…':'Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²')}`);
  populateMenu();
  renderLessons();
  await loadState();
  populateTeacherSelects();
  populateFeedbackTeachers();
  renderBooksPage();
  startPolling();
}

/* ========== Menu ========== */
function populateMenu(){
  const panel = document.getElementById('menuPanel'); panel.innerHTML='';
  // All roles get books, lessons, profile, logout
  addMenuItem(panel,'ğŸ“˜ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§', ()=> openSection('booksPage') );
  addMenuItem(panel,'ğŸ“š Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†', ()=> showMyLessons() );
  if(currentRole === 'student'){
    addMenuItem(panel,'ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ ØªÚ©Ù„ÛŒÙ', ()=> openSection('submitPage') );
    addMenuItem(panel,'ğŸ’¬ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ù…Ø¹Ù„Ù…', ()=> openSection('feedbackPage') );
    addMenuItem(panel,'ğŸ—‚ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ø§Ù„ÛŒÙ', ()=> openAssignmentsPageForRole() );
    addMenuItem(panel,'ğŸ”” Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§', ()=> toggleNotifications() );
    addMenuItem(panel,'ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„', ()=> openSection('profilePage') );
    addMenuItem(panel,'ğŸšª Ø®Ø±ÙˆØ¬', ()=> logout() );
  } else { // teacher or manager: all teacher functions + delete DB
    addMenuItem(panel,'ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ ØªÚ©Ù„ÛŒÙ Ø¨Ù‡ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†', ()=> openSection('teacherBroadcastPage') );
    addMenuItem(panel,'ğŸ—‚ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÚ©Ø§Ù„ÛŒÙ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²Ø§Ù†', ()=> openAssignmentsPageForRole() );
    addMenuItem(panel,'ğŸ”” Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§', ()=> toggleNotifications() );
    addMenuItem(panel,'ğŸ—‘ï¸ Ø­Ø°Ù Ø¯ÛŒØªØ§Ø¨ÛŒØ³', ()=> { if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾ÙˆÛŒØ§ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ')) api('/delete-database','POST'); } );
    addMenuItem(panel,'ğŸ‘¤ Ù¾Ø±ÙˆÙØ§ÛŒÙ„', ()=> openSection('profilePage') );
    addMenuItem(panel,'ğŸšª Ø®Ø±ÙˆØ¬', ()=> logout() );
  }
}
function addMenuItem(panel, text, fn){ const d = document.createElement('div'); d.innerText = text; d.onclick = ()=> { panel.style.display='none'; fn(); }; panel.appendChild(d); }

/* ========== Lessons UI ========== */
function renderLessons(){
  const wrap = document.getElementById('lessonsWrap'); wrap.innerHTML='';
  SUBJECTS.forEach(sub=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<strong>${sub}</strong><br><span class="small">Ù…Ø¹Ù„Ù…: ${getTeacherOfLesson(sub)}</span>`;
    div.onclick = ()=> openLesson(sub);
    wrap.appendChild(div);
  });
}
function showMyLessons(){
  const wrap = document.getElementById('lessonsWrap'); wrap.innerHTML='';
  SUBJECTS.forEach(sub=>{
    if(currentRole==='teacher' || currentRole==='manager'){
      if(currentUser === getTeacherOfLesson(sub) || MANAGERS.includes(currentUser)){ // managers can see all if desired
        const div=document.createElement('div');div.className='card';div.innerHTML=`<strong>${sub}</strong>`;div.onclick=()=>openLesson(sub);wrap.appendChild(div);
      }
    } else {
      const div=document.createElement('div');div.className='card';div.innerHTML=`<strong>${sub}</strong><br><small>${getTeacherOfLesson(sub)}</small>`;div.onclick=()=>openLesson(sub);wrap.appendChild(div);
    }
  });
}

/* ========== Open Lesson & Buttons ========== */
function openLesson(lesson){
  currentLesson = lesson;
  openSection('lessonPage');
  setText('lessonTitle', lesson);
  setText('lessonTeacher', `Ù…Ø¹Ù„Ù…: ${getTeacherOfLesson(lesson)}`);
  renderLessonButtons();
  renderLessonInfo();
}
function renderLessonInfo(){
  const infoDiv = document.getElementById('lessonInfo');
  // show broadcasts (assignments with empty student) for this lesson
  const broadcasts = state.assignments.filter(a => a.lesson === currentLesson && (!a.student || a.student===''));
  let html = '';
  broadcasts.forEach(b=>{
    html += `<div class="notice"><small>${b.time||''}</small><br>${b.text ? b.text + '<br>' : ''}${b.fileName?`<a class="downloadLink" href="${b.fileUrl}" target="_blank">${b.fileName}</a>`:''}</div>`;
  });
  infoDiv.innerHTML = html || 'Ù‡ÛŒÚ† Ø§Ø·Ù„Ø§Ø¹ÛŒÙ‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.';
}
function renderLessonButtons(){
  const div=document.getElementById('lessonButtons'); div.innerHTML='';
  const teacher = getTeacherOfLesson(currentLesson);
  const active = state.sessions[currentLesson];
  // managers also have teacher capabilities
  if((currentRole==='teacher' && currentUser===teacher) || (currentRole==='manager' && MANAGERS.includes(currentUser))){
    const startBtn=document.createElement('button'); startBtn.className='button'; startBtn.innerText='â–¶ Ø´Ø±ÙˆØ¹ Ø¬Ù„Ø³Ù‡'; startBtn.onclick=()=> startSession(currentLesson);
    const endBtn=document.createElement('button'); endBtn.className='button'; endBtn.innerText='â¹ Ù¾Ø§ÛŒØ§Ù† Ø¬Ù„Ø³Ù‡'; endBtn.onclick=()=> endSession(currentLesson);
    div.appendChild(startBtn); div.appendChild(endBtn);
  } else if(currentRole==='student'){
    const joinBtn=document.createElement('button'); joinBtn.className='button hidden'; joinBtn.id='studentJoinBtn'; joinBtn.innerText='â–¶ Ù¾ÛŒÙˆØ³ØªÙ† Ø¨Ù‡ Ø¬Ù„Ø³Ù‡'; joinBtn.onclick=()=> joinSession(currentLesson);
    div.appendChild(joinBtn);
    if(active) joinBtn.classList.remove('hidden'); else joinBtn.classList.add('hidden');
  }
}

/* ========== Session actions (start/end/join) ========== */
async function startSession(lesson){
  await api('/start-class','POST',{ teacher: currentUser, lesson });
  // open Jitsi
  const meetingName = encodeURIComponent(`${lesson}-MySchoolMeeting`);
  window.open(`https://meet.jit.si/${meetingName}#userInfo.displayName="${encodeURIComponent(currentUser)}"&moderator=true`, '_blank');
  await loadState();
  renderLessonButtons();
}
async function endSession(lesson){
  await api('/end-class','POST',{ teacher: currentUser, lesson });
  await loadState();
  renderLessonButtons();
  openSection('dashboard');
}
function joinSession(lesson){
  const meetingName = encodeURIComponent(`${lesson}-MySchoolMeeting`);
  window.open(`https://meet.jit.si/${meetingName}#userInfo.displayName="${encodeURIComponent(currentUser)}"`, '_blank');
}

/* ========== Books ========== */
async function renderBooksPage(){
  const el = document.getElementById('booksList'); el.innerHTML='';
  const r = await api('/books','GET');
  const b = r || {};
  for(const k in b){
    const a = document.createElement('a'); a.href = b[k]; a.target='_blank'; a.className='downloadLink'; a.innerText = k;
    el.appendChild(a); el.appendChild(document.createElement('br'));
  }
}

/* ========== Selects population ========== */
function populateTeacherSelects(){
  const tsel = document.getElementById('sendTeacherSelect'); tsel.innerHTML='';
  TEACHERS.concat(MANAGERS).forEach(t=>{ const o=document.createElement('option'); o.value=t; o.innerText=t; tsel.appendChild(o); });
  const lsel = document.getElementById('sendLessonSelect'); lsel.innerHTML='';
  SUBJECTS.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.innerText=s; lsel.appendChild(o); });
  const tbsel = document.getElementById('teacherBroadcastLesson'); if(tbsel){ tbsel.innerHTML=''; SUBJECTS.forEach(s=>{ if(getTeacherOfLesson(s)===currentUser || MANAGERS.includes(currentUser)){ const o=document.createElement('option'); o.value=s; o.innerText=s; tbsel.appendChild(o); } }); }
}
function populateFeedbackTeachers(){
  const sel = document.getElementById('feedbackTeacherSelect'); sel.innerHTML='';
  TEACHERS.concat(MANAGERS).forEach(t=>{ const o=document.createElement('option'); o.value=t; o.innerText=t; sel.appendChild(o); });
}

/* ========== Student send assignment (upload then send) ========== */
async function studentSendAssignment(){
  const lesson = document.getElementById('sendLessonSelect').value;
  const teacher = document.getElementById('sendTeacherSelect').value;
  const fileInput = document.getElementById('sendFile');
  if(!fileInput.files[0]){ alert('ÛŒÚ© ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯'); return; }
  const fd = new FormData(); fd.append('file', fileInput.files[0]);
  const up = await fetch('/api/upload',{ method:'POST', body: fd });
  const j = await up.json();
  if(!j.ok){ alert('Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚'); return; }
  await api('/send-assignment','POST',{ student: currentUser, teacher, lesson, fileUrl: j.fileUrl, fileName: j.fileName });
  document.getElementById('sendMsg').innerText = 'Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!';
  setTimeout(()=>document.getElementById('sendMsg').innerText='',2000);
  fileInput.value='';
  await loadState();
}

/* ========== Teacher broadcast (assignment to students) ========== */
async function teacherBroadcast(){
  const lesson = document.getElementById('teacherBroadcastLesson').value;
  const text = document.getElementById('teacherBroadcastText').value.trim();
  const fileInput = document.getElementById('teacherBroadcastFile');
  let fileUrl=null, fileName=null;
  if(fileInput.files[0]){
    const fd = new FormData(); fd.append('file', fileInput.files[0]);
    const jres = await fetch('/api/upload', { method:'POST', body: fd });
    const j = await jres.json();
    if(j.ok){ fileUrl = j.fileUrl; fileName = j.fileName; }
  }
  await api('/teacher-broadcast','POST',{ teacher: currentUser, lesson, text, fileUrl, fileName });
  document.getElementById('teacherBroadcastMsg').innerText='Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯!';
  setTimeout(()=>document.getElementById('teacherBroadcastMsg').innerText='',2000);
  document.getElementById('teacherBroadcastText').value=''; if(fileInput) fileInput.value='';
  await loadState();
}

/* ========== Teacher view assignments & send feedback ========== */
async function openAssignmentsPageForRole(){
  openSection('assignmentsPage');
  const controls = document.getElementById('assignControls'); controls.innerHTML='';
  if(currentRole==='teacher' || currentRole==='manager'){
    const sel = document.createElement('select'); sel.id='selectStudent';
    STUDENTS.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.innerText=s; sel.appendChild(o); });
    controls.appendChild(sel);
    const btn = document.createElement('button'); btn.className='button'; btn.innerText='Ù†Ù…Ø§ÛŒØ´ ØªÚ©Ø§Ù„ÛŒÙ'; btn.onclick=renderTeacherViewStudentAssignments;
    controls.appendChild(btn);
  } else {
    const sel = document.createElement('select'); sel.id='selectLesson';
    SUBJECTS.forEach(s=>{ const o=document.createElement('option'); o.value=s; o.innerText=s; sel.appendChild(o); });
    controls.appendChild(sel);
    const btn = document.createElement('button'); btn.className='button'; btn.innerText='Ù†Ù…Ø§ÛŒØ´ ØªÚ©Ø§Ù„ÛŒÙ'; btn.onclick=renderStudentViewLessonAssignments;
    controls.appendChild(btn);
  }
  document.getElementById('assignList').innerHTML='';
}

async function renderTeacherViewStudentAssignments(){
  const student = document.getElementById('selectStudent').value;
  const wrap = document.getElementById('assignList'); wrap.innerHTML='';
  await loadState();
  let found=false;
  state.assignments.slice().reverse().forEach(it=>{
    if(it.student===student){
      found=true;
      const div = document.createElement('div'); div.className='assignmentItem';
      div.innerHTML = `Ø¯Ø±Ø³: <strong>${it.lesson}</strong><br>Ù…Ø¹Ù„Ù…: ${it.teacher}<br>ÙØ§ÛŒÙ„: ${it.fileName?`<a class="downloadLink" href="${it.fileUrl}" target="_blank">${it.fileName}</a>`:'Ø¨Ø¯ÙˆÙ† ÙØ§ÛŒÙ„'}<br><small>${it.time||''}</small>`;
      div.innerHTML += `<br><label class="small">Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ (Ù…ØªÙ†)</label><textarea id="fb_${it.id}" rows="2" style="width:100%"></textarea><div style="margin-top:6px"><button class="button" onclick="teacherSendFeedback('${it.lesson}','${student}','${it.id}')">Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯</button></div>`;
      wrap.appendChild(div);
    }
  });
  if(!found) wrap.innerHTML = '<div class="notice">Ù‡ÛŒÚ† ØªÚ©Ù„ÛŒÙÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
}

async function renderStudentViewLessonAssignments(){
  const lesson = document.getElementById('selectLesson').value;
  const wrap = document.getElementById('assignList'); wrap.innerHTML='';
  await loadState();
  const mine = state.assignments.filter(a=>a.lesson===lesson && a.student===currentUser);
  if(mine.length===0) { wrap.innerHTML='<div class="notice">Ù‡ÛŒÚ† ØªÚ©Ù„ÛŒÙÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>'; return; }
  mine.forEach(it=>{
    const div = document.createElement('div'); div.className='assignmentItem';
    div.innerHTML = `Ø¯Ø±Ø³: <strong>${it.lesson}</strong><br>Ù…Ø¹Ù„Ù…: ${it.teacher}<br>ÙØ§ÛŒÙ„: ${it.fileName?`<a class="downloadLink" href="${it.fileUrl}" target="_blank">${it.fileName}</a>`:'Ø¨Ø¯ÙˆÙ† ÙØ§ÛŒÙ„'}<br><small>${it.time||''}</small>`;
    wrap.appendChild(div);
  });
}

async function teacherSendFeedback(lesson, student, assignmentId){
  const ta = document.getElementById(`fb_${assignmentId}`);
  const text = ta ? ta.value.trim() : '';
  if(!text){ alert('Ù…ØªÙ† Ø®Ø§Ù„ÛŒ Ø§Ø³Øª'); return; }
  await api('/send-feedback','POST',{ teacher: currentUser, student, lesson, text });
  alert('Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯');
  await loadState();
}

/* ========== Student feedback list (student view) ========== */
function renderStudentFeedbacks(){
  const wrap = document.getElementById('feedbackResults'); wrap.innerHTML='';
  const sel = document.getElementById('feedbackTeacherSelect');
  const teacher = sel ? sel.value : null;
  const list = state.feedbacks.filter(f => f.student===currentUser && (!teacher || f.teacher===teacher));
  if(list.length===0){ wrap.innerHTML = '<div class="notice">Ù‡Ù†ÙˆØ² Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>'; return; }
  list.forEach(it=>{
    const d = document.createElement('div'); d.className='assignmentItem';
    d.innerHTML = `<strong>Ù…Ø¹Ù„Ù…: ${it.teacher}</strong><br>${it.text}<br><small>${it.time}</small><br><small>Ø¯Ø±Ø³: ${it.lesson}</small>`;
    wrap.appendChild(d);
  });
}

/* ========== Change password ========== */
async function changePassword(){
  const p1 = document.getElementById('newPassword').value.trim();
  const p2 = document.getElementById('newPassword2').value.trim();
  if(!p1 || p1!==p2){ alert('Ø±Ù…Ø²Ù‡Ø§ Ø®Ø§Ù„ÛŒ ÛŒØ§ ÛŒÚ©Ø³Ø§Ù† Ù†ÛŒØ³Øª'); return; }
  const res = await api('/change-password','POST',{ user: currentUser, newPassword: p1 });
  if(res.ok){ setText('profileMsg','Ø±Ù…Ø² ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!'); setTimeout(()=>setText('profileMsg',''),2000); document.getElementById('newPassword').value=''; document.getElementById('newPassword2').value=''; }
  else alert('Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ø±Ù…Ø²');
}

/* ========== Notifications UI & operations ========== */
function toggleNotifications(){
  const box = document.getElementById('notificationsBox'); if(box.classList.contains('hidden')) openNotifications(); else closeNotifications();
}
function openNotifications(){
  document.getElementById('notificationsBox').classList.remove('hidden');
  // mark read when opened? We'll provide a button to mark all read; but viewing should not auto mark all.
  renderNotificationsList();
}
function closeNotifications(){ document.getElementById('notificationsBox').classList.add('hidden'); }
async function renderNotificationsList(){
  const listEl = document.getElementById('notificationsList'); listEl.innerHTML='';
  // Filter relevant
  const arr = state.notifications.filter(n => n.to === 'students' || n.to === currentUser);
  if(arr.length===0){ listEl.innerHTML = '<div class="notice">Ø§Ø¹Ù„Ø§Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>'; return; }
  arr.forEach(n=>{
    const el = document.createElement('div'); el.className='alert-item';
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><small>${n.time}</small><br>${n.text}</div><div><button onclick="markRead('${n.id}')" ${n.read?'disabled':''}>Ù…Ø´Ø§Ù‡Ø¯Ù‡</button></div></div>`;
    listEl.appendChild(el);
  });
  renderBell();
}
async function markRead(id){
  await api('/notifications/mark-read','POST',{ id, user: currentUser });
  await loadState();
  renderNotificationsList();
}
async function markAllRead(){
  await api('/notifications/mark-all-read','POST',{ user: currentUser });
  await loadState();
  renderNotificationsList();
}
function renderBell(){
  const count = state.notifications.filter(n => (n.to === 'students' || n.to === currentUser) && !n.read).length;
  const dot = document.getElementById('bellDot'); if(count>0){ dot.style.display='inline-block'; dot.innerText = count; } else dot.style.display='none';
}

/* ========== Polling + state load ========= */
let pollTimer = null;
async function loadState(){
  const res = await api('/state','GET');
  state.sessions = res.sessions || {};
  state.assignments = res.assignments || [];
  state.feedbacks = res.feedbacks || [];
  state.notifications = res.notifications || [];
  state.books = res.books || {};
  renderBell();
  // update lesson buttons if open
  if(currentLesson) renderLessonButtons();
}
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(()=> loadState().catch(()=>{}), POLL_INTERVAL);
}

/* ========== Utilities ========== */
function getTeacherOfLesson(lesson){
  if(lesson === 'Ø¯ÛŒÙ†ÛŒ' || lesson==='Ù‚Ø±Ø¢Ù†') return 'Ø¢Ù‚Ø§ÛŒ Ø­Ø³ÛŒÙ†ÛŒ';
  let h=0; for(let i=0;i<lesson.length;i++){ h = ((h<<5)-h)+lesson.charCodeAt(i); h |= 0; }
  return TEACHERS[Math.abs(h)%TEACHERS.length];
}
function logout(){ currentUser=null; currentRole=null; currentLesson=null; if(pollTimer) clearInterval(pollTimer); hideAllSections(); document.getElementById('loginSection').style.display='block'; }

/* ========== Init on load ====== */
hideAllSections(); document.getElementById('loginSection').style.display='block';
renderLessons();
renderBooksPage();
populateTeacherSelects();
populateFeedbackTeachers();

// UI bindings
document.getElementById('menuToggle').addEventListener('click', ()=>{ const p = document.getElementById('menuPanel'); p.style.display = p.style.display==='block' ? 'none' : 'block'; });
document.getElementById('bellBtn').addEventListener('click', ()=> toggleNotifications());

// expose functions used inline
window.doLogin = doLogin;
window.openSection = openSection;
window.goToDashboard = openSection.bind(null,'dashboard');
window.studentSendAssignment = studentSendAssignment;
window.teacherBroadcast = teacherBroadcast;
window.populateTeacherSelects = populateTeacherSelects;
window.populateFeedbackTeachers = populateFeedbackTeachers;
window.renderStudentFeedbacks = renderStudentFeedbacks;
window.startSession = startSession;
window.endSession = endSession;
window.joinSession = joinSession;
window.logout = logout;
window.markAllRead = markAllRead;
window.renderNotifications = renderNotificationsList;

</script>
</body>
</html>
